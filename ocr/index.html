<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OCR de Placas (Escáner con Confirmación)</title>
  <style>
    :root { --bg:#0b1220; --card:#111827; --muted:#6b7280; --ok:#10b981; --err:#ef4444; --brand:#0ea5e9; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:#e5e7eb;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue','Noto Sans',Arial}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.3)}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .col{flex:1 1 320px;min-width:280px}
    video,canvas,.ph{width:100%;border-radius:12px;background:#0f172a}
    .ph{display:grid;place-items:center;aspect-ratio:16/9;border:1px dashed #374151;color:#64748b}
    .btn{appearance:none;border:0;border-radius:10px;padding:10px 14px;cursor:pointer;font-weight:600;background:#1f2937;color:#fff}
    .btn:hover{background:#243042}
    .btn.brand{background:var(--brand)}
    .btn.brand:hover{filter:brightness(1.05)}
    .btn.warn{background:#9333ea}
    .stack{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .status{margin-top:10px;font-size:14px;color:var(--muted)}
    .badge{display:inline-block;background:#0b2534;border:1px solid #164a61;color:#9dd9ff;padding:4px 8px;border-radius:999px;font-size:12px}
    input[type="text"]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #374151;background:#0f172a;color:#fff;outline:none}
    .pill{display:inline-flex;align-items:center;gap:10px;background:#0f172a;border:1px solid #243042;padding:10px 12px;border-radius:12px}
    .ok{color:var(--ok)} .err{color:var(--err)} .muted{color:#94a3b8}
  </style>
</head>
<body>
  <div class="wrap">
    <h1 style="margin:6px 0 12px">OCR de Placas <span class="badge">flujo con Confirmar</span></h1>

    <div class="row">
      <!-- Cámara / Captura -->
      <div class="col">
        <div class="card">
          <h3 style="margin:6px 0 12px">1) Cámara</h3>
          <video id="video" playsinline autoplay muted class="ph"></video>
          <div class="stack">
            <button id="btnStart" class="btn brand">Activar cámara</button>
            <button id="btnStop" class="btn">Detener</button>
            <button id="btnShot" class="btn warn">Capturar</button>
          </div>
          <div id="estadoCam" class="status muted">Cámara inactiva</div>
        </div>
      </div>

      <!-- Procesado / OCR -->
      <div class="col">
        <div class="card">
          <h3 style="margin:6px 0 12px">2) OCR</h3>
          <canvas id="canvas" class="ph"></canvas>
          <div class="stack">
            <button id="btnOCR" class="btn">Reconocer texto</button>
            <button id="btnClean" class="btn">Limpiar</button>
          </div>
          <div id="estadoOCR" class="status muted">Sin procesar</div>
          <div style="margin-top:8px" id="resultadoOCR" class="pill muted">–</div>
        </div>
      </div>
    </div>

    <!-- Confirmación -->
    <div class="card" style="margin-top:16px">
      <h3 style="margin:6px 0 12px">3) Revisar y Confirmar</h3>
      <div class="row">
        <div class="col">
          <label class="muted" for="inpPlaca">Placa detectada (puedes corregirla)</label>
          <input id="inpPlaca" type="text" placeholder="ABC123 o ABC1234" />
        </div>
        <div class="col" style="display:flex;align-items:flex-end">
          <div class="stack">
            <button id="btnConfirm" class="btn brand">Confirmar y enviar</button>
            <button id="btnGoSistema" class="btn">Ir al Sistema</button>
          </div>
        </div>
      </div>
      <div id="estadoSend" class="status muted">Esperando confirmación…</div>
    </div>
  </div>

  <!-- Tesseract.js (OCR) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <script>
    // ===== Util =====
    const $ = (q) => document.querySelector(q);
    const video = $('#video'), canvas = $('#canvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    const estadoCam = $('#estadoCam'), estadoOCR = $('#estadoOCR'), estadoSend = $('#estadoSend');
    const resultadoOCR = $('#resultadoOCR'), inpPlaca = $('#inpPlaca');

    const constraints = { audio: false, video: { facingMode: 'environment' } };
    let stream = null;

    function setStatus(el, text, cls='muted') {
      el.className = 'status ' + cls;
      el.textContent = text;
    }

    function normalizePlaca(s) {
      const raw = String(s || '').toUpperCase().replace(/[^A-Z0-9]/g, ' ');
      const tokens = raw.split(/\s+/).filter(Boolean);
      // Patrones comunes: ABC123, ABC1234, AB123CD, 123ABC
      const re = /^(?:[A-Z]{3}\d{3,4}|[A-Z]{2}\d{3}[A-Z]{1,2}|\d{3}[A-Z]{3})$/;
      let best = '';
      for (const t of tokens) {
        if (t.length >= 5 && t.length <= 8 && re.test(t)) { best = t; break; }
      }
      if (!best) best = (tokens.sort((a,b)=>b.length-a.length)[0] || '').slice(0,8);
      return best;
    }

    async function enviarPendiente(raw) {
      const placa = normalizePlaca(raw);
      if (!placa) { setStatus(estadoSend, 'Placa inválida', 'err'); return; }
      try {
        const r = await fetch('/api/pendientes', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ placa })
        });
        const data = await r.json();
        if (!r.ok) throw new Error(data?.msg || 'Error al enviar');
        try { localStorage.setItem('placaDetectadaOCR', placa); } catch {}
        setStatus(estadoSend, `Enviado: ${placa} ✓`, 'ok');
        return data;
      } catch (e) {
        setStatus(estadoSend, `Fallo al enviar: ${e.message}`, 'err');
        console.error(e);
      }
    }

    // ===== Cámara =====
    async function start() {
      try {
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        setStatus(estadoCam, 'Cámara activa', 'ok');
      } catch (e) {
        console.error(e);
        setStatus(estadoCam, 'No se pudo activar la cámara', 'err');
      }
    }
    function stop() {
      if (stream) stream.getTracks().forEach(t => t.stop());
      stream = null;
      setStatus(estadoCam, 'Cámara detenida', 'muted');
    }

    function shot() {
      if (!video.videoWidth) { setStatus(estadoCam, 'Espera que el video cargue', 'err'); return false; }
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      setStatus(estadoOCR, 'Imagen capturada. Reconoce para leer.', 'muted');
      return true;
    }

    // ===== OCR =====
    async function hacerOCR() {
      try {
        const blob = await new Promise(res => canvas.toBlob(res, 'image/png', 1));
        if (!blob) { setStatus(estadoOCR, 'No hay imagen', 'err'); return; }
        setStatus(estadoOCR, 'Reconociendo…', 'muted');
        const { data } = await Tesseract.recognize(blob, 'spa+eng', {
          logger: m => (m.status && (estadoOCR.textContent = `Reconociendo: ${m.status}...`))
        });
        const text = (data && data.text) ? data.text : '';
        const placa = normalizePlaca(text);
        resultadoOCR.textContent = placa || (text.trim() || '—');
        inpPlaca.value = placa;
        if (placa) setStatus(estadoOCR, 'Placa detectada ✓ (revisa antes de confirmar)', 'ok');
        else setStatus(estadoOCR, 'No se encontró un patrón claro. Corrige manual y confirma.', 'err');
      } catch (e) {
        console.error(e);
        setStatus(estadoOCR, 'Error en OCR: ' + e.message, 'err');
      }
    }

    // ===== UI =====
    $('#btnStart').addEventListener('click', start);
    $('#btnStop').addEventListener('click', stop);

    // Capturar → hacer OCR (pero NO enviar)
    $('#btnShot').addEventListener('click', async () => {
      if (shot()) await hacerOCR();
    });

    // Botón "Reconocer" por si quieres reintentar OCR sin volver a capturar
    $('#btnOCR').addEventListener('click', hacerOCR);

    $('#btnClean').addEventListener('click', () => {
      ctx.clearRect(0,0,canvas.width,canvas.height);
      resultadoOCR.textContent = '–'; inpPlaca.value = '';
      setStatus(estadoOCR, 'Limpio', 'muted'); setStatus(estadoSend, 'Esperando confirmación…', 'muted');
    });

    // Confirmar → enviar a /api/pendientes
    $('#btnConfirm').addEventListener('click', async () => {
      await enviarPendiente(inpPlaca.value);
    });

    // Ir al sistema (opcional)
    $('#btnGoSistema').addEventListener('click', () => location.href = '/');

    // UX: autoupper y sin caracteres raros
    inpPlaca.addEventListener('input', (e)=> e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g,''));
  </script>
</body>
</html>
