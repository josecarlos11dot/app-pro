<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Captura OCR desde c√°mara en vivo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; padding: 1rem; background: #111; color: #fff; text-align: center; }
    video, canvas { width: 100%; max-width: 480px; border: 2px solid #ccc; border-radius: 10px; }
    #contenedorCamara { position: relative; display: inline-block; }
    #guia {
      position: absolute;
      top: 50%; left: 50%;
      width: 250px; height: 80px;
      transform: translate(-50%, -50%);
      border: 2px dashed red; box-sizing: border-box;
      pointer-events: none;
    }
    #estadoOCR, #estadoSend { margin: 1rem 0; font-weight: bold; }
    button {
      padding: 10px 20px; font-size: 1rem; margin-top: .8rem;
      border-radius: 8px; border: none; background-color: #00c853; color: white; cursor: pointer;
    }
    button.secondary { background:#444; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    input[type="text"] {
      width: 100%; max-width: 320px; padding: .6rem .8rem;
      border-radius: 8px; border: 1px solid #444; background: #000; color: #fff;
    }
    .fila { display:flex; gap:12px; justify-content:center; flex-wrap:wrap; }
    .ok{color:#10b981} .warn{color:#f59e0b} .err{color:#ef4444}
  </style>
</head>
<body>

  <h2>Captura de Placa (C√°mara en Vivo)</h2>

  <div id="contenedorCamara">
    <video id="video" autoplay muted playsinline></video>
    <div id="guia"></div>
  </div>

  <div class="fila">
    <button id="btnCapturar" disabled>üì∏ Capturar</button>
    <button id="btnReintentar" class="secondary">Reintentar</button>
  </div>

  <p id="estadoOCR">Cargando c√°mara‚Ä¶</p>

  <div class="fila" style="margin-top:.5rem">
    <input type="text" id="resultadoPlaca" placeholder="Placa detectada (puedes corregirla)..." />
  </div>

  <div class="fila">
    <button id="btnConfirmar">‚úÖ Confirmar </button>
  </div>

  <p id="estadoSend">Esperando confirmaci√≥n‚Ä¶</p>

  <!-- canvases ocultos -->
  <canvas id="canvasFull" style="display:none;"></canvas>
  <canvas id="canvasROI" style="display:none;"></canvas>

  <script>
    const video = document.getElementById('video');
    const canvasFull = document.getElementById('canvasFull');
    const canvasROI = document.getElementById('canvasROI');
    const estadoOCR = document.getElementById('estadoOCR');
    const estadoSend = document.getElementById('estadoSend');
    const inputPlaca = document.getElementById('resultadoPlaca');
    const btnCapturar = document.getElementById('btnCapturar');
    const btnReintentar = document.getElementById('btnReintentar');
    const btnConfirmar = document.getElementById('btnConfirmar');
    const guia = document.getElementById('guia');

    // ‚ö†Ô∏è Reemplaza por tu token (ideal moverlo a backend despu√©s)
    const API_TOKEN = 'TU_TOKEN_PLATERECOGNIZER';

    // === 1) C√°mara ===
    async function iniciarCamara() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment' }, audio: false
        });
        video.srcObject = stream;
        video.addEventListener('loadedmetadata', () => {
          if (video.videoWidth && video.videoHeight) {
            btnCapturar.disabled = false;
            estadoOCR.textContent = 'C√°mara activa. Enfoca la placa dentro del recuadro y presiona Capturar.';
          }
        });
      } catch (err) {
        console.error('No se pudo acceder a la c√°mara:', err);
        estadoOCR.innerHTML = 'Error al acceder a la c√°mara ‚ùå';
      }
    }
    iniciarCamara();

    // Normaliza texto a formato de placa razonable
    function normalizarPlaca(s) {
      return String(s || '').toUpperCase().replace(/[^A-Z0-9]/g, '');
    }

    // === 2) Capturar solo el ROI (marco gu√≠a) ===
    function capturarROI() {
      const vw = video.videoWidth, vh = video.videoHeight;
      if (!vw || !vh) return null;

      // Pinta el frame completo a tama√±o real
      canvasFull.width = vw; canvasFull.height = vh;
      const ctxFull = canvasFull.getContext('2d', { willReadFrequently: true });
      ctxFull.drawImage(video, 0, 0, vw, vh);

      // Mapea el rect√°ngulo gu√≠a (CSS px) a coordenadas del frame (px reales)
      const vRect = video.getBoundingClientRect();
      const gRect = guia.getBoundingClientRect();

      const fx = (gRect.left - vRect.left) / vRect.width;
      const fy = (gRect.top - vRect.top) / vRect.height;
      const fw = gRect.width / vRect.width;
      const fh = gRect.height / vRect.height;

      // ROI en coordenadas del frame real
      const sx = Math.max(0, Math.floor(fx * vw));
      const sy = Math.max(0, Math.floor(fy * vh));
      const sw = Math.max(1, Math.floor(fw * vw));
      const sh = Math.max(1, Math.floor(fh * vh));

      // Dibuja ROI a un canvas del tama√±o del ROI
      canvasROI.width = sw; canvasROI.height = sh;
      const ctxROI = canvasROI.getContext('2d', { willReadFrequently: true });
      ctxROI.drawImage(canvasFull, sx, sy, sw, sh, 0, 0, sw, sh);

      return canvasROI;
    }

    // === 3) Enviar ROI a PlateRecognizer (sin redirigir) ===
    async function reconocerPlaca() {
      try {
        const roiCanvas = capturarROI();
        if (!roiCanvas) {
          estadoOCR.className = 'err';
          estadoOCR.textContent = 'No se pudo capturar. Intenta de nuevo.';
          return;
        }
        estadoOCR.className = '';
        estadoOCR.textContent = 'Procesando imagen‚Ä¶';

        const blob = await new Promise(res => roiCanvas.toBlob(res, 'image/jpeg', 0.95));
        const formData = new FormData();
        formData.append('upload', blob, 'captura.jpg');
        formData.append('regions', 'mx');
        formData.append('detection_detail', 'true');
        formData.append('camera_id', 'camara-viva');
        formData.append('config', JSON.stringify({
          blur: true,
          vehicle_detection: true,
          multiple_plates: false,
          country: 'mx',
          detect_region: true
        }));

        const res = await fetch('https://api.platerecognizer.com/v1/plate-reader/', {
          method: 'POST',
          headers: { Authorization: `Token ${API_TOKEN}` },
          body: formData
        });

        const data = await res.json();
        console.log('Respuesta PlateRecognizer:', data);

        const resultado = data.results?.[0];
        if (!resultado) {
          estadoOCR.className = 'err';
          estadoOCR.textContent = 'No se detect√≥ placa ‚ùå';
          inputPlaca.value = '';
          return;
        }

        const placa = normalizarPlaca(resultado.plate);
        const score = Number(resultado.score || 0);
        inputPlaca.value = placa;

        if (score >= 0.85) {
          estadoOCR.className = 'ok';
          estadoOCR.textContent = `Placa detectada ‚úì (${placa}) ‚Äî revisa y confirma.`;
        } else {
          estadoOCR.className = 'warn';
          estadoOCR.textContent = `Duda en lectura ‚ö†Ô∏è (${placa}). Corrige y confirma.`;
        }
      } catch (err) {
        console.error('Error con PlateRecognizer:', err);
        estadoOCR.className = 'err';
        estadoOCR.textContent = 'Error al procesar imagen ‚ùå';
      }
    }

    // === 4) Confirmar y enviar a /api/pendientes (misma p√°gina, sin redirigir) ===
    let enviando = false;
    async function confirmarYEnviar() {
      const placa = normalizarPlaca(inputPlaca.value);
      if (!placa || placa.length < 5) {
        estadoSend.className = 'err';
        estadoSend.textContent = 'Placa inv√°lida. Corrige antes de enviar.';
        return;
      }
      if (enviando) return;
      enviando = true;
      btnConfirmar.disabled = true;

      try {
        estadoSend.className = '';
        estadoSend.textContent = 'Enviando‚Ä¶';

        const r = await fetch('/api/pendientes', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ placa })
        });
        const data = await r.json();
        if (!r.ok) throw new Error(data?.msg || 'Error al enviar');

        try { localStorage.setItem('placaDetectadaOCR', placa); } catch {}
        estadoSend.className = 'ok';
        estadoSend.textContent = `Enviado ‚úì (${placa}). Permaneces en OCR.`;
        // ‚õîÔ∏è Sin redirecci√≥n, por tu flujo de esc√°ner
      } catch (e) {
        console.error(e);
        estadoSend.className = 'err';
        estadoSend.textContent = 'No se pudo enviar la placa: ' + e.message;
      } finally {
        enviando = false;
        btnConfirmar.disabled = false;
      }
    }

    // === 5) Eventos UI ===
    btnCapturar.addEventListener('click', reconocerPlaca);
    btnReintentar.addEventListener('click', () => {
      estadoOCR.className=''; estadoSend.className='';
      estadoOCR.textContent = 'Enfoca y vuelve a Capturar.';
      estadoSend.textContent = 'Esperando confirmaci√≥n‚Ä¶';
      inputPlaca.value = '';
    });
    btnConfirmar.addEventListener('click', confirmarYEnviar);

    // UX: autoupper y sin caracteres raros
    inputPlaca.addEventListener('input', (e)=> e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g,''));
  </script>
</body>
</html>
