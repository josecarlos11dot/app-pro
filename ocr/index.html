<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Captura OCR desde cÃ¡mara en vivo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; padding: 1rem; background: #111; color: #fff; text-align: center; }
    video, canvas { width: 100%; max-width: 480px; border: 2px solid #ccc; border-radius: 10px; }
    #guia {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 250px;
      height: 80px;
      transform: translate(-50%, -50%);
      border: 2px dashed red;
      box-sizing: border-box;
      pointer-events: none;
    }
    #contenedorCamara {
      position: relative;
      display: inline-block;
    }
    #estadoOCR, #estadoSend { margin: 1rem 0; font-weight: bold; } /* âœ… estadoSend */
    button {
      padding: 10px 20px;
      font-size: 1rem;
      margin-top: 1rem;
      border-radius: 8px;
      border: none;
      background-color: #00c853;
      color: white;
      cursor: pointer;
    }
    input[type="text"] {
      width: 100%;
      max-width: 320px;
      padding: .6rem .8rem;
      border-radius: 8px;
      border: 1px solid #444;
      background: #000;
      color: #fff;
    }
  </style>
</head>
<body>

  <h2>Captura de Placa (CÃ¡mara en Vivo)</h2>

  <div id="contenedorCamara">
    <video id="video" autoplay muted playsinline></video>
    <div id="guia"></div>
  </div>

  <button id="btnCapturar">ðŸ“¸ Capturar</button>

  <p id="estadoOCR">Esperando captura...</p>
  <input type="text" id="resultadoPlaca" placeholder="Placa detectada..." />

  <!-- âœ… BotÃ³n de confirmaciÃ³n -->
  <div>
    <button id="btnConfirmar">âœ… Confirmar y enviar</button>
  </div>
  <p id="estadoSend">Esperando confirmaciÃ³nâ€¦</p> <!-- âœ… Mensaje de envÃ­o -->

  <canvas id="canvas" style="display:none;"></canvas>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const estadoOCR = document.getElementById('estadoOCR');
    const estadoSend = document.getElementById('estadoSend');   // âœ…
    const inputPlaca = document.getElementById('resultadoPlaca');
    const btnCapturar = document.getElementById('btnCapturar');
    const btnConfirmar = document.getElementById('btnConfirmar'); // âœ…
    const ctx = canvas.getContext('2d');

    // âš ï¸ Nota: este token estÃ¡ en el front. MÃ¡s adelante conviene pasarlo a un backend.
    const API_TOKEN = '3f8ef072e79205794e226ac4c63907d1b081c500';

    // (opcional) genera tarjetas locales con botÃ³n "Registrar" (no lo usamos ya)
    function agregarPlacaPendiente(placaDetectada) { /* ... se puede dejar como estaba ... */ }

    // âŒ Eliminamos la redirecciÃ³n automÃ¡tica. Ya no se usa enviarPlacaAlSistema.
    // function enviarPlacaAlSistema(placa) { ... }

    // === 1. Activar cÃ¡mara ===
    async function iniciarCamara() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment' },
          audio: false
        });
        video.srcObject = stream;

        // âœ… Evita capturar antes de que el video tenga dimensiones
        btnCapturar.disabled = true;
        video.addEventListener('loadedmetadata', () => {
          if (video.videoWidth && video.videoHeight) {
            btnCapturar.disabled = false;
          }
        });
      } catch (err) {
        console.error('No se pudo acceder a la cÃ¡mara:', err);
        estadoOCR.textContent = 'Error al acceder a la cÃ¡mara âŒ';
      }
    }
    iniciarCamara();

    // === 2. Capturar imagen al hacer clic (misma lÃ³gica que te funcionaba) ===
    btnCapturar.addEventListener('click', async () => {
      canvas.width = video.videoWidth || 640;
      canvas.height = video.videoHeight || 360;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      estadoOCR.textContent = 'Procesando imagen...';

      canvas.toBlob(async (blob) => {
        const formData = new FormData();
        formData.append('upload', blob, 'captura.jpg');
        formData.append('regions', 'mx');
        formData.append('detection_detail', 'true');
        formData.append('camera_id', 'camara-viva');
        formData.append('config', JSON.stringify({
          blur: true,
          vehicle_detection: true,
          multiple_plates: false,
          country: 'mx',
          detect_region: true
        }));

        try {
          const res = await fetch('https://api.platerecognizer.com/v1/plate-reader/', {
            method: 'POST',
            headers: {
              Authorization: `Token ${API_TOKEN}`
            },
            body: formData
          });

          const data = await res.json();
          console.log('Respuesta completa:', data);

          const resultado = data.results?.[0];

          if (resultado) {
            // âœ… Normalizamos y MOSTRAMOS, pero YA NO REDIRIGIMOS
            const placa = (resultado.plate || '').toUpperCase().replace(/[^A-Z0-9]/g, '');
            inputPlaca.value = placa;

            const score = Number(resultado.score || 0);
            if (score < 0.85) {
              estadoOCR.textContent = `Duda en lectura âš ï¸ (${placa}). Corrige y CONFIRMA.`;
            } else {
              estadoOCR.textContent = `Placa detectada âœ… (${placa}). Revisa y CONFIRMA.`;
            }

          } else {
            estadoOCR.textContent = 'No se detectÃ³ placa âŒ';
            inputPlaca.value = '';
          }

        } catch (err) {
          console.error('Error al enviar a Plate Recognizer:', err);
          estadoOCR.textContent = 'Error al procesar imagen âŒ';
        }

      }, 'image/jpeg', 0.9);
    });

    // âœ… 3. Confirmar y enviar a tu backend (Vercel /api/pendientes) â€” SIN redirigir
    let enviando = false;
    btnConfirmar.addEventListener('click', async () => {
      const placa = (inputPlaca.value || '').toUpperCase().replace(/[^A-Z0-9]/g, '');
      if (!placa || placa.length < 5) {
        estadoSend.textContent = 'Placa invÃ¡lida. Corrige antes de enviar.';
        return;
      }
      if (enviando) return;
      enviando = true;
      btnConfirmar.disabled = true;

      try {
        estadoSend.textContent = 'Enviandoâ€¦';

        const r = await fetch('/api/pendientes', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ placa })
        });
        const data = await r.json();
        if (!r.ok) throw new Error(data?.msg || 'Error al enviar');

        try { localStorage.setItem('placaDetectadaOCR', placa); } catch {}
        estadoSend.textContent = `Enviado âœ“ (${placa}). Permanece en OCR.`;
      } catch (e) {
        console.error(e);
        estadoSend.textContent = 'No se pudo enviar la placa: ' + e.message;
      } finally {
        enviando = false;
        btnConfirmar.disabled = false;
      }
    });

    // âœ… Input en mayÃºsculas sin caracteres raros
    inputPlaca.addEventListener('input', (e)=> {
      e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
    });
  </script>

</body>
</html>
